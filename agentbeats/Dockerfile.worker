FROM python:3.13-slim

WORKDIR /app

RUN apt-get update && apt-get install -y git curl && rm -rf /var/lib/apt/lists/*

# Build context should be repo root: docker build -f agentbeats/Dockerfile.worker .
COPY pyproject.toml pdm.lock README.md ./
COPY src/ ./src/
COPY data/ ./data/
COPY agentbeats/tau2_worker.py ./

# Initialize git repo so tau2 can get commit hash
RUN git init && git config user.email "worker@tau2.local" && git config user.name "Tau2 Worker" && git add . && git commit -m "Initial commit"

RUN pip install --no-cache-dir -e . && pip install --no-cache-dir python-dotenv fastapi uvicorn

ENV TAU2_DATA_DIR=/app/data
EXPOSE 9200

ENTRYPOINT ["python", "tau2_worker.py"]
CMD ["--host", "0.0.0.0", "--port", "9200"]
